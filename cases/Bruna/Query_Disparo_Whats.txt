WITH HIST_DISP AS (
SELECT TRUNC(to_date(DATA_ARQUIVO,'YYYY-MM-DD HH24:MI:SS')) AS DATA_DISPARO,
	--CASE WHEN T2.SCORE_TEL_EC IS NULL THEN '0-SEM SCORE' ELSE T2.SCORE_TEL_EC END AS SCORE_TEL_EC,
	COUNT(NU_LOGICO_EQUIP) AS TOTAL
FROM SBOXSASOP.PRED_BTR_HIST_DISPARO HST
LEFT JOIN SBOXSASOP.TMP_SCORE_TELEFONES T2 ON CAST( HST.NU_SO_EC AS INT) = T2.NU_SO_EC
WHERE TRUNC(to_date(DATA_ARQUIVO,'YYYY-MM-DD HH24:MI:SS')) >= TO_DATE('2023-09-04', 'YYYY-MM-DD')
GROUP BY TRUNC(to_date(DATA_ARQUIVO,'YYYY-MM-DD HH24:MI:SS'))--, T2.SCORE_TEL_EC
),

RESPOSTAS AS (
SELECT DISTINCT
	TRUNC(DH_ABRT_CHMD) AS DH_DISPARO,
	--NU_LGCO_EQPM,
	GTEC.NU_SO_EC,	
	CD_STCO_CHMD,
	CD_SRVC_EXCT_GTEC as resp_n_trat,
	CD_EVNT_GTEC,
	CD_OCRC,
	CASE 
		WHEN CD_STCO_CHMD = 'MCS' AND CD_SRVC_EXCT_GTEC = '583' THEN 'Resposta invalida' 
		WHEN CD_STCO_CHMD = 'MCS' AND CD_SRVC_EXCT_GTEC = '582' THEN 'Nao quer a troca'
		WHEN CD_STCO_CHMD = 'MCS' AND CD_SRVC_EXCT_GTEC = '149' THEN 'Telefone invalido'
		WHEN CD_STCO_CHMD = 'MCS' AND CD_SRVC_EXCT_GTEC = '131' THEN 'Tempo de resposta expirado'
		WHEN CD_STCO_CHMD = 'MCS' AND CD_SRVC_EXCT_GTEC = '180' THEN 'OPTOUT'
		WHEN CD_STCO_CHMD = 'MCS' THEN 'Outro problema'
		WHEN CD_STCO_CHMD = 'RAD' THEN 'Sim, quer a troca'
		ELSE 'Algum codigo invalido'
	END AS RESPOSTA,
	MIN(CAST(NU_CHMD_EDS_RFRN AS NUMBER)) AS NU_CHMD_EDS_RFRN
FROM dw.tbdwr_chmd_gtec GTEC
LEFT JOIN DMSIE.TBDWR_EC_TESTE_LGST EC_TESTE ON GTEC.NU_SO_EC = EC_TESTE.NU_SO_EC 
WHERE 
CD_EVNT_GTEC = 3030
AND (
		((cd_stco_chmd = 'RAD' OR cd_stco_chmd LIKE 'M%') AND CD_OCRC = 531)
	)
AND TRUNC(DH_ABRT_CHMD) > TO_DATE('2023-09-04', 'YYYY-MM-DD') 
AND EC_TESTE.NU_EC IS NULL
GROUP BY TRUNC(DH_ABRT_CHMD), GTEC.NU_SO_EC,CD_STCO_CHMD,CD_SRVC_EXCT_GTEC,CD_EVNT_GTEC,CD_OCRC
),

RESP_DISP AS (
SELECT COALESCE(resp.NU_SO_EC,ret.NU_SO_EC) AS NU_SO_EC,
		RET.TEL_CHAVE AS TEL_SENT,
		RESP.DH_DISPARO AS DATA_DISPARO,
		CASE WHEN RET.SENT IS NULL THEN 'Nao foi enviado' ELSE 'Foi enviado' END AS FOI_ENVIADO,
		CASE WHEN RET.DELIVERED IS NULL THEN 'Nao foi entregue' ELSE 'Foi entregue' END AS FOI_ENTREGUE,
		CASE WHEN RET.READ IS NULL THEN 'Nao foi lido' ELSE 'Foi lido' END AS FOI_LIDO,
		RESP.RESPOSTA 
FROM RESPOSTAS RESP   
LEFT JOIN SBOXSASOP.RETORNO_COMPLETO_0409 RET ON RET.NU_SO_EC = RESP.NU_SO_EC AND TRUNC(TO_TIMESTAMP(RET.SENT, 'DD/MM/YY HH24:MI:SS')) = RESP.DH_DISPARO
),

CHMDS AS (
	SELECT 
	TRUNC(CHMDS.DH_ABRT_CHMD) AS DATA_ABRT,
        CASE WHEN CHMDS.DH_ENCE_CHMD<CHMDS.DH_ABRT_CHMD THEN 'EM ABERTO'
            WHEN CHMDS.CD_STCO_CHMD LIKE '_CV' THEN 'CANCELADO COM VISITA'
            WHEN CHMDS.CD_STCO_CHMD LIKE '_CS' THEN 'CANCELADO SEM VISITA'
        ELSE 'ATENDIDO' END AS STCO_CHMD,
    CHMDS.NU_SO_EC,
    CHMDS.DC_SRVC_EXCT_GTEC AS MOT_CNCL
	FROM dw.tbdwr_chmd_gtec CHMDS 
	INNER JOIN SBOXSASOP.TMP_RESPOSTAS_0409 T1 
		ON CHMDS.NU_CHMD_EDS_RFRN = T1.NU_CHMD_EDS_RFRN AND CHMDS.NU_SO_EC = T1.NU_SO_EC
	WHERE CHMDS.DH_ABRT_CHMD >= TO_TIMESTAMP('2023-09-04 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
		AND CHMDS.CD_OCRC_MNUT = 531 AND NU_SQNC_CHMD = 0
),

REAT AS (
	--Reativos bateria com ou sem estímulo
SELECT 
	TRUNC(CHMDS.DH_CNRD_ENCE_CHMD) AS DATA_CHMD,
	COUNT(CHMDS.NU_SO_EC) AS TOTAL_REATIVO_BAT
FROM SBOXSASOP.IDCRV_FATO_CHAMADOS CHMDS 
WHERE CHMDS.DH_CNRD_ENCE_CHMD >= TO_TIMESTAMP('2023-09-04 00:00:00', 'YYYY-MM-DD HH24:MI:SS') --AND TO_TIMESTAMP('2023-10-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
	AND CHMDS.CD_OCRC_MNUT = 31 AND CD_STCO_CHMD NOT LIKE '_CS' AND CHMDS.DH_CNRD_ENCE_CHMD>CHMDS.DH_ABRT_CHMD AND CHMDS.IN_IDC = 1
GROUP BY TRUNC(CHMDS.DH_CNRD_ENCE_CHMD)
),

--------- Parte reativo com estimulo
FATOS_CHMD AS (SELECT NU_CHMD, NU_SO_EC, DH_ABRT_CHMD, DH_CNRD_ENCE_CHMD, NU_LGCO_EQPM
FROM SBOXSASOP.IDCRV_FATO_CHAMADOS CHMDS 
WHERE CHMDS.DH_CNRD_ENCE_CHMD >= TO_TIMESTAMP('2023-09-04 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
	AND CHMDS.CD_OCRC_MNUT = 31 AND CD_STCO_CHMD NOT LIKE '_CS' AND CHMDS.DH_CNRD_ENCE_CHMD>CHMDS.DH_ABRT_CHMD AND CHMDS.IN_IDC = 1),

	
RETORNO AS (SELECT
	T1.NU_SO_EC,
	TRUNC(to_date(T2.DATA_ARQUIVO,'YYYY-MM-DD HH24:MI:SS')) AS DATA_DISPARO,
	TRUNC(to_timestamp(T1.DELIVERED,'DD/MM/YY HH24:MI:SS')) AS ENTREGUE,
	TRUNC(TO_TIMESTAMP(T1."READ", 'DD/MM/YY HH24:MI:SS')) AS LIDO,
	T2.NU_LOGICO_EQUIP,
	T1.TEL_CHAVE
FROM SBOXSASOP.RETORNO_COMPLETO_0409 T1
LEFT JOIN SBOXSASOP.TMP_PRED_BTR_HIST_DISPARO T2 ON T1.NU_SO_EC = T2.NU_SO_EC 
	AND TRUNC(to_timestamp(T1.DELIVERED,'DD/MM/YY HH24:MI:SS')) = TRUNC(to_date(T2.DATA_ARQUIVO,'YYYY-MM-DD HH24:MI:SS'))
LEFT JOIN DMSIE.TBDWR_EC_TESTE_LGST EC_TESTE ON t1.NU_SO_EC = EC_TESTE.NU_SO_EC 
WHERE T1."READ" IS NOT NULL and ec_teste.nu_ec is null),

REAT_ESTM AS (
SELECT 
	TRUNC(DH_ABRT_CHMD) AS DATA_CHMD,
	COUNT(NU_SO_EC) AS TOTAL_REAT_ESTM
FROM 
	(SELECT RETORNO.*, 
	DH_ABRT_CHMD,
	TRUNC(DH_ABRT_CHMD) - ENTREGUE AS DIF_DIAS,
	ROW_NUMBER () OVER (PARTITION BY RETORNO.NU_SO_EC, RETORNO.ENTREGUE ORDER BY FATOS_CHMD.DH_ABRT_CHMD) AS RNB
	FROM FATOS_CHMD
	LEFT JOIN RETORNO ON RETORNO.NU_SO_EC = FATOS_CHMD.NU_SO_EC 
	AND RETORNO.NU_LOGICO_EQUIP = FATOS_CHMD.NU_LGCO_EQPM
	AND DH_ABRT_CHMD >= RETORNO.ENTREGUE) 
WHERE RNB = 1 AND DIF_DIAS >= 0 AND DIF_DIAS <= 5
GROUP BY TRUNC(DH_ABRT_CHMD)
),
--------- Fim da parte reativo com estimulo

HD AS (
	--Proativos abertos pela central
SELECT 
	TRUNC(CHMDS.DH_ABRT_CHMD) AS DATA_CHMD,
    COUNT(CHMDS.NU_SO_EC) AS TOTAL_PROATIVO_HD
FROM dw.tbdwr_chmd_gtec CHMDS 
--INNER JOIN SBOXSASOP.TMP_RESPOSTAS_0409 T1 ON CHMDS.NU_CHMD_EDS_RFRN = T1.NU_CHMD_EDS_RFRN AND CHMDS.NU_SO_EC = T1.NU_SO_EC
WHERE CHMDS.DH_ABRT_CHMD >= TO_TIMESTAMP('2023-09-04 00:00:00', 'YYYY-MM-DD HH24:MI:SS') --AND TO_TIMESTAMP('2023-10-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
	AND CHMDS.CD_OCRC_MNUT NOT IN (531, 532, 529, 530) AND NU_SQNC_CHMD = 0 AND CD_EVNT_GTEC = 3030 AND CD_STCO_CHMD NOT LIKE '_C_' AND CHMDS.DH_ENCE_CHMD>CHMDS.DH_ABRT_CHMD
	AND CD_STCO_CHMD LIKE 'T%'
GROUP BY TRUNC(CHMDS.DH_ABRT_CHMD)
),
REAT_HD AS (
SELECT COALESCE(REAT.DATA_CHMD,HD.DATA_CHMD) AS DATA_CHMD,
	TOTAL_REATIVO_BAT,
	TOTAL_PROATIVO_HD
FROM HD 
FULL JOIN REAT ON REAT.DATA_CHMD = HD.DATA_CHMD
),
AGRUP1 AS (
	--Agrega todas as bases do proativo wa 
	--Respostas (GTEC), retorno (INFOMART), chamados (FATO/GTEC), disparos (SANDBOX)
SELECT 
    DATA_DISPARO,
	--SCORE_TEL_EC,
	COUNT(1) AS TOTAL_CAPTURA,
	SUM(CASE WHEN FOI_ENVIADO = 'Foi enviado' THEN 1 ELSE 0 END) AS TOTAL_ENVIADO,
	SUM(CASE WHEN RESPOSTA IN ('Telefone invalido') THEN 0 ELSE 1 END) AS TOTAL_VALIDO,
	SUM(CASE WHEN FOI_ENTREGUE = 'Foi entregue' THEN 1 ELSE 0 END) AS TOTAL_ENTREGUE,
	SUM(CASE WHEN FOI_LIDO = 'Foi lido' THEN 1 ELSE 0 END) AS TOTAL_LIDO,
	SUM(CASE WHEN RESPOSTA IN ('Sim, quer a troca','Nao quer a troca') THEN 1 ELSE 0 END) AS TOTAL_RESPONDEU,
	SUM(CASE WHEN RESPOSTA IN ('Sim, quer a troca','Nao quer a troca', 'OPTOUT') THEN 1 ELSE 0 END) AS TOTAL_RESP_COMPLETA,
	SUM(CASE WHEN RESPOSTA IN ('OPTOUT') THEN 1 ELSE 0 END) AS TOTAL_OPTOUT,
	SUM(CASE WHEN RESPOSTA IN ('Sim, quer a troca') THEN 1 ELSE 0 END) AS TOTAL_RESPOSTA_SIM,
	SUM(CASE WHEN CHMDS.STCO_CHMD = 'ATENDIDO' THEN 1 ELSE 0 END) AS TOTAL_ATENDIDO,
	SUM(CASE WHEN CHMDS.STCO_CHMD = 'CANCELADO COM VISITA' THEN 1 ELSE 0 END) AS TOTAL_CANC_CVIS,
	SUM(CASE WHEN CHMDS.STCO_CHMD = 'CANCELADO SEM VISITA' THEN 1 ELSE 0 END) AS TOTAL_CANC_SVIS,
	SUM(CASE WHEN CHMDS.STCO_CHMD = 'EM ABERTO' THEN 1 ELSE 0 END) AS TOTAL_EM_ABERTO
FROM RESP_DISP
LEFT JOIN CHMDS ON RESP_DISP.DATA_DISPARO = CHMDS.DATA_ABRT AND RESP_DISP.NU_SO_EC = CHMDS.NU_SO_EC
GROUP BY DATA_DISPARO--,SCORE_TEL_EC
),

AGRUP2 AS (
	--Juntando reativos com proativos (preferência da tabela REAT_HD pois tem dias sem disparo de proativos)
SELECT REAT_HD.DATA_CHMD AS DATA_DISPARO,
	HIST_DISP.TOTAL,
	TOTAL_CAPTURA,
	TOTAL_ENVIADO,
	TOTAL_VALIDO,
	TOTAL_ENTREGUE,
	TOTAL_LIDO,
	TOTAL_RESPONDEU,
	TOTAL_RESP_COMPLETA,
	TOTAL_OPTOUT,
	TOTAL_RESPOSTA_SIM,
	TOTAL_ATENDIDO,
	TOTAL_CANC_CVIS,
	TOTAL_CANC_SVIS,
	TOTAL_EM_ABERTO,
	TOTAL_REATIVO_BAT,
	TOTAL_PROATIVO_HD,
	TOTAL_REAT_ESTM
FROM REAT_HD 
LEFT JOIN (SELECT * FROM AGRUP1 WHERE TOTAL_CAPTURA > 100 AND TOTAL_ENVIADO > 100) AGRUP1 
	ON REAT_HD.DATA_CHMD = AGRUP1.DATA_DISPARO --AND HIST_DISP.SCORE_TEL_EC = AGRUP1.SCORE_TEL_EC
LEFT JOIN HIST_DISP ON HIST_DISP.DATA_DISPARO = REAT_HD.DATA_CHMD 
LEFT JOIN REAT_ESTM ON REAT_ESTM.DATA_CHMD = REAT_HD.DATA_CHMD
)

SELECT DATA_DISPARO,
	CASE WHEN TOTAL_CAPTURA IS NULL THEN NULL 
		WHEN TOTAL IS NULL OR TOTAL < TOTAL_CAPTURA 
			THEN (CASE WHEN TOTAL_CAPTURA <= 500 THEN 500
						WHEN TOTAL_CAPTURA <= 1499 THEN 1499
						WHEN TOTAL_CAPTURA <= 1999 THEN 1999
						WHEN TOTAL_CAPTURA <= 2999 THEN 2999
						ELSE TOTAL END)
		ELSE TOTAL END AS TOTAL,
--	TOTAL,
	TOTAL_CAPTURA,
	TOTAL_ENVIADO,
	TOTAL_VALIDO,
	TOTAL_ENTREGUE,
	TOTAL_LIDO,
	TOTAL_RESPONDEU,
	TOTAL_RESP_COMPLETA,
	TOTAL_OPTOUT,
	TOTAL_RESPOSTA_SIM,
	TOTAL_ATENDIDO,
	TOTAL_CANC_CVIS,
	TOTAL_CANC_SVIS,
	TOTAL_EM_ABERTO,
	TOTAL_REATIVO_BAT,
	TOTAL_PROATIVO_HD,
	TOTAL_REAT_ESTM
FROM AGRUP2 
ORDER BY DATA_DISPARO
--WHERE TOTAL_CAPTURA > 100 AND TOTAL_ENVIADO > 100